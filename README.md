# arkadius-bot

Карл — Telegram бот, написанный на TypeScript. Он использует ChatGPT 4o и отвечает в групповых чатах при упоминании или ответе на его сообщение.

## Возможности

- Команда `/menu` открывает меню бота. Все дальнейшие действия выполняются через кнопки.
- Доступ выдаётся на конкретного пользователя; только он может экспортировать данные или сбрасывать память через меню до истечения срока.
- Откликается, если его упомянут, ответят на сообщение бота или начнут сообщение с имени Карл.
- При отсутствии упоминаний или ответов отвечает только после нескольких сообщений с признаком интереса (`{interested:true}`).
- Запоминает предыдущие сообщения в SQLite и суммирует длинные чаты для сохранения контекста.
- Определяет отношение бота к пользователям и сохраняет его, учитывая при ответах.
- Персона бота описана в `prompts/persona.md`.

## Одобрение и бан чатов

При первом сообщении из незнакомого чата бот отправляет администратору запрос с кнопками «Разрешить» и «Забанить». Пока чат не одобрен, сообщения из него игнорируются. Все действия по выдаче доступа или бану выполняются администратором через кнопки без использования команд.

## Установка

1. Установите зависимости:
   ```bash
   npm install
   ```
2. Создайте `.env` с токенами Telegram и OpenAI и при необходимости настройте дополнительные параметры:
   ```
   BOT_TOKEN=your-telegram-token
   OPENAI_API_KEY=your-openai-key
   CHAT_HISTORY_LIMIT=50        # сколько сообщений хранить до суммаризации
   ADMIN_CHAT_ID=123456         # ID чата администратора для выдачи ключей
   ```

Если вы добавляете или изменяете переменные окружения, не забудьте обновить файл `.env.example`. 3. Запустите в режиме разработки:

```bash
npm run dev
```

4. Собрайте проект:
   ```bash
   npm run build
   ```
5. Примените миграции БД:
   ```bash
   npm run migration:up
   ```
   Если файл `memory.db` уже существует и не содержит таблицу `migrations`,
   скрипт автоматически удалит его перед применением миграций.
6. Запустите собранную версию:
   ```bash
   npm start
   ```

Для проверки типов и тестов можно выполнить:

```bash
npm exec tsc
npm test
npm run test:coverage
```

Для автоудаления неиспользуемых импортов запускайте:

```bash
npm run lint:fix
```

В проекте запрещено использовать тип `any` и директивы `@ts-`. Все такие
участки кода должны быть отрефакторены и заменены на явные типы.

## Структура проекта

- `src/index.ts` — точка входа приложения.
- `src/bot/TelegramBot.ts` — логика бота и обработка сообщений.
- `src/services/ai/ChatGPTService.ts` — взаимодействие c OpenAI.
- `src/services/chat/ChatMemory.ts` — хранение истории и её суммаризация.
- `dist/` — собранные файлы.
- Сервисы определяются через интерфейсы и Symbol-ключи Inversify; реализации
  привязываются в `src/container.ts`.

### Маршрутизатор и windowConfig

В `windowConfig` описываются окна меню и их кнопки с помощью `createRoute` и
`createButton`. Эти функции возвращают объекты, соответствующие типам
`RouteApi` и `ButtonApi`, и позволяют типизировать идентификаторы окон и
доступные действия.

`registerRoutes` регистрирует обработчики `callback_data`, показывает окна и
управляет стеком переходов. При навигации предыдущее сообщение удаляется, а при
наличии истории автоматически добавляется кнопка «⬅️ Назад». Для показа окна
используйте `router.show(ctx, id)`. Функции действий можно указывать прямо в
кнопках.

### Структура БД

В SQLite используются следующие основные таблицы:

- `users` — сведения о пользователях бота, включая поле `attitude` для отношения бота.
- `chat_users` — связь между чатами и пользователями.
- `messages` — история сообщений.
- `summaries` — краткие пересказы чатов.

Репозиторий полностью базируется на npm и TypeScript.

## Прогресс тестирования

- Добавлены тесты для `RepositoryMessageService`, `FilePromptService` и `MessageContextExtractor`,
  что повысило их покрытие до более чем 90%.
